# –ê–Ω–∞–ª–∏–∑ –ª–æ–≥–æ–≤ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è SSEUnitOfWork

**–î–∞—Ç–∞**: 2026-02-08  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –°–µ—Ä–≤–∏—Å –∑–∞–ø—É—â–µ–Ω —Å –Ω–æ–≤—ã–º –∫–æ–¥–æ–º

## –õ–æ–≥–∏ –î–û –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### –ü–æ—Å–ª–µ–¥–Ω–∏–π —É—Å–ø–µ—à–Ω—ã–π –∑–∞–ø—Ä–æ—Å (20:33:55 - 20:33:57)

```
2026-02-08 20:33:55,799 - Found conversation b629d9c9-4e35-4410-86e4-199fad684cc7
2026-02-08 20:33:55,807 - Saved conversation b629d9c9-4e35-4410-86e4-199fad684cc7
2026-02-08 20:33:55,822 - Saved agent 62015795-46a8-437a-80f7-b840ea5e374e
2026-02-08 20:33:57,659 - Saved conversation b629d9c9-4e35-4410-86e4-199fad684cc7
2026-02-08 20:33:57,664 - Assistant message persisted and committed (no tool calls)
2026-02-08 20:33:57,667 - SSEUnitOfWork: Context exiting normally
2026-02-08 20:33:57,667 - SSEUnitOfWork: Session ownership retained by FastAPI
```

### –ö–ª—é—á–µ–≤—ã–µ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è

1. **‚úÖ –°–æ–æ–±—â–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è–ª–∏—Å—å**:
   - `Saved conversation` - 2 —Ä–∞–∑–∞
   - `Assistant message persisted and committed`

2. **‚ö†Ô∏è UoW –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–ª —Å–µ—Å—Å–∏—é**:
   ```
   SSEUnitOfWork: Session ownership retained by FastAPI
   ```
   –≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ UoW –ø–æ–ª–∞–≥–∞–ª—Å—è –Ω–∞ FastAPI –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è —Å–µ—Å—Å–∏–∏.

3. **‚ùå –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞**:
   - FastAPI –∑–∞–∫—Ä—ã–≤–∞–µ—Ç —Å–µ—Å—Å–∏—é –ü–û–°–õ–ï –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è endpoint
   - –ù–æ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –Ω–∞—á–∏–Ω–∞–µ—Ç —Ä–∞–±–æ—Ç—É –ü–û–°–õ–ï –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è endpoint
   - –≠—Ç–æ race condition, –∫–æ—Ç–æ—Ä–∞—è –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –æ—à–∏–±–∫–∞–º

## –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

### –ß—Ç–æ –∏–∑–º–µ–Ω–µ–Ω–æ

**–î–æ**:
```python
@router.post("/stream")
async def message_stream_sse(
    db: AsyncSession = Depends(get_db),  # ‚ùå FastAPI —É–ø—Ä–∞–≤–ª—è–µ—Ç —Å–µ—Å—Å–∏–µ–π
):
    async def generate():
        async with SSEUnitOfWork(existing_session=db) as uow:
            # –†–∞–±–æ—Ç–∞ —Å —Å–µ—Å—Å–∏–µ–π, –∫–æ—Ç–æ—Ä–∞—è –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–∫—Ä—ã—Ç–∞
```

**–ü–æ—Å–ª–µ**:
```python
@router.post("/stream")
async def message_stream_sse(request: MessageStreamRequest):
    async def generate():
        async with async_session_maker() as db:  # ‚úÖ –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —É–ø—Ä–∞–≤–ª—è–µ—Ç —Å–µ—Å—Å–∏–µ–π
            use_case = get_container().get_process_message_use_case(db)
            async with SSEUnitOfWork(existing_session=db) as uow:
                # –†–∞–±–æ—Ç–∞ —Å –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –∂–∏–≤–æ–π —Å–µ—Å—Å–∏–µ–π
            await db.commit()  # ‚úÖ –§–∏–Ω–∞–ª—å–Ω—ã–π commit
```

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

1. **‚úÖ –Ø–≤–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º**:
   - –°–µ—Å—Å–∏—è —Å–æ–∑–¥–∞–µ—Ç—Å—è –≤ –Ω–∞—á–∞–ª–µ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞
   - –°–µ—Å—Å–∏—è –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è –≤ –∫–æ–Ω—Ü–µ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞
   - –ù–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç FastAPI DI

2. **‚úÖ –ù–µ—Ç race conditions**:
   - –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ø–æ–ª–Ω–æ—Å—Ç—å—é –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç —Å–µ—Å—Å–∏—é
   - FastAPI –Ω–µ –º–æ–∂–µ—Ç –∑–∞–∫—Ä—ã—Ç—å —Å–µ—Å—Å–∏—é –ø—Ä–µ–∂–¥–µ–≤—Ä–µ–º–µ–Ω–Ω–æ

3. **‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ –æ–ø–µ—Ä–∞—Ü–∏–π**:
   ```
   1. –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä: async with async_session_maker() as db:
   2. –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä: async with SSEUnitOfWork(existing_session=db):
   3. –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä: async for chunk in use_case.execute():
   4. –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä: await db.commit()
   5. –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä: __aexit__ ‚Üí await db.close()
   ```

## –û–∂–∏–¥–∞–µ–º—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –ª–æ–≥–∞—Ö

### –°—Ç–∞—Ä—ã–µ –ª–æ–≥–∏
```
SSEUnitOfWork: Session ownership retained by FastAPI
```

### –ù–æ–≤—ã–µ –ª–æ–≥–∏ (–æ–∂–∏–¥–∞–µ–º—ã–µ)
```
SSEUnitOfWork: Context exiting normally
SSEUnitOfWork: Session closed by generator
```

–ò–ª–∏ –ø—Ä–æ—Å—Ç–æ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ "retained by FastAPI", —Ç–∞–∫ –∫–∞–∫ —Ç–µ–ø–µ—Ä—å –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –≤–ª–∞–¥–µ–µ—Ç —Å–µ—Å—Å–∏–µ–π.

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 1. –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞
```bash
$ docker compose up -d --build agent-runtime
‚úÖ Container codelab-ai-service-agent-runtime-1  Started
```

### 2. Health check
```
INFO: 127.0.0.1:33622 - "GET /health HTTP/1.1" 200 OK
```

### 3. –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å:
1. **User message** - –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ–±—ã—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
2. **Tool result** - –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
3. **Switch agent** - –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –∞–≥–µ–Ω—Ç–∞
4. **HITL decision** - –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–µ—à–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
5. **Plan decision** - –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–µ—à–µ–Ω–∏–µ –ø–æ –ø–ª–∞–Ω—É

–î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–µ—Å—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:
- ‚úÖ –°–æ–æ–±—â–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –ë–î
- ‚úÖ –ù–µ—Ç –æ—à–∏–±–æ–∫ —Å –∑–∞–∫—Ä—ã—Ç–æ–π —Å–µ—Å—Å–∏–µ–π
- ‚úÖ –õ–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∂–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª —Å–µ—Å—Å–∏–∏

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ß—Ç–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –≤ –ª–æ–≥–∞—Ö

1. **–°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Å—Å–∏–∏**:
   ```
   async with async_session_maker() as db:
   ```

2. **–†–∞–±–æ—Ç–∞ UoW**:
   ```
   SSEUnitOfWork: Context exiting normally
   ```

3. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö**:
   ```
   Saved conversation <session_id>
   Assistant message persisted and committed
   ```

4. **–û—à–∏–±–∫–∏** (–Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å):
   ```
   ‚ùå Session is closed
   ‚ùå Cannot operate on a closed session
   ‚ùå This session is in 'closed' state
   ```

## –í—ã–≤–æ–¥

‚úÖ **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–æ**:
- –°–µ—Ä–≤–∏—Å –ø–µ—Ä–µ—Å–æ–±—Ä–∞–Ω –∏ –∑–∞–ø—É—â–µ–Ω
- Health check –ø—Ä–æ—Ö–æ–¥–∏—Ç
- –ì–æ—Ç–æ–≤ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é

‚è≥ **–¢—Ä–µ–±—É–µ—Ç—Å—è**:
- –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö 5 —Ç–∏–ø–æ–≤ —Å–æ–æ–±—â–µ–Ω–∏–π
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫
- –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ –ë–î

üéØ **–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç**:
- –í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- –ù–µ—Ç –æ—à–∏–±–æ–∫ —Å –∑–∞–∫—Ä—ã—Ç–æ–π —Å–µ—Å—Å–∏–µ–π
- UoW —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –∂–∏–≤–æ–π —Å–µ—Å—Å–∏–∏
- –§–∏–Ω–∞–ª—å–Ω—ã–π commit –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —É—Å–ø–µ—à–Ω–æ

---

**–ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–æ**: CodeLab Team  
**–°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã**:
- [`SSE_UOW_FIX_REPORT.md`](SSE_UOW_FIX_REPORT.md) - –û—Ç—á–µ—Ç –æ–± –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏
- [`SSE_UOW_USAGE_ANALYSIS.md`](SSE_UOW_USAGE_ANALYSIS.md) - –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã
