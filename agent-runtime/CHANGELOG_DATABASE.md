# Database Structure Improvements - Changelog

## [2.0.0] - 2026-01-02

### üéâ Major Changes

–ü–æ–ª–Ω–∞—è –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö —Å –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–µ–π –∏ —É–ª—É—á—à–µ–Ω–Ω–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é.

### ‚ú® Added

#### –ù–æ–≤—ã–µ —Ç–∞–±–ª–∏—Ü—ã
- **`messages`** - –æ—Ç–¥–µ–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π (–≤–º–µ—Å—Ç–æ JSON)
- **`agent_switches`** - –æ—Ç–¥–µ–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–π –∞–≥–µ–Ω—Ç–æ–≤

#### –ù–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏
- **–ü–∞–≥–∏–Ω–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π**: `get_messages_paginated(session_id, page, page_size)`
- **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–µ—Å—Å–∏–π**: `get_session_stats(session_id)` - –ø–æ–¥—Å—á–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π, —Ç–æ–∫–µ–Ω–æ–≤
- **–ò—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–π**: `get_agent_switch_history(session_id, limit)`
- **Soft delete**: –º—è–≥–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
- **Hard delete**: `hard_delete_old_sessions(days_old)` –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- **Context manager**: `session_scope()` –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

#### –£–ª—É—á—à–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- –ö–æ–º–ø–æ–∑–∏—Ç–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è —á–∞—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- Foreign Keys —Å –∫–∞—Å–∫–∞–¥–Ω—ã–º —É–¥–∞–ª–µ–Ω–∏–µ–º
- Connection pooling –¥–ª—è PostgreSQL
- –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ JOIN –∑–∞–ø—Ä–æ—Å—ã

### üîÑ Changed

#### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü
- **`sessions`**: –¥–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–ª—è `id`, `is_active`, `deleted_at`
- **`agent_contexts`**: –¥–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–ª—è `id`, `updated_at`, –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–æ `metadata` -> `metadata_json`
- –í—Å–µ JSON –ø–æ–ª—è —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É—é—Ç —Å—É—Ñ—Ñ–∏–∫—Å `_json` –¥–ª—è —è—Å–Ω–æ—Å—Ç–∏

#### API –∏–∑–º–µ–Ω–µ–Ω–∏—è
- `list_all_sessions()` —Ç–µ–ø–µ—Ä—å –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä `include_deleted`
- `delete_session()` —Ç–µ–ø–µ—Ä—å –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä `soft` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é True)
- –í—Å–µ –º–µ—Ç–æ–¥—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç –æ–±—Ä–∞—Ç–Ω—É—é —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

### üóÑÔ∏è Database Schema

#### –°—Ç–∞—Ä–∞—è —Å—Ö–µ–º–∞ (v1.0)
```
sessions (2 —Ç–∞–±–ª–∏—Ü—ã)
‚îú‚îÄ‚îÄ sessions: session_id, messages (JSON), last_activity, created_at
‚îî‚îÄ‚îÄ agent_contexts: session_id, current_agent, agent_history (JSON), metadata (JSON)
```

#### –ù–æ–≤–∞—è —Å—Ö–µ–º–∞ (v2.0)
```
sessions (4 —Ç–∞–±–ª–∏—Ü—ã —Å relationships)
‚îú‚îÄ‚îÄ sessions: id, session_id, created_at, last_activity, is_active, deleted_at
‚îú‚îÄ‚îÄ messages: id, session_db_id (FK), role, content, timestamp, tool_calls, metadata_json
‚îú‚îÄ‚îÄ agent_contexts: id, session_db_id (FK), current_agent, created_at, updated_at, metadata_json
‚îî‚îÄ‚îÄ agent_switches: id, context_db_id (FK), from_agent, to_agent, switched_at, reason
```

### üìä Performance Improvements

- **–ü–æ–∏—Å–∫ —Å–æ–æ–±—â–µ–Ω–∏–π**: ~60% –±—ã—Å—Ç—Ä–µ–µ –±–ª–∞–≥–æ–¥–∞—Ä—è –∏–Ω–¥–µ–∫—Å–∞–º
- **–ü–∞–≥–∏–Ω–∞—Ü–∏—è**: O(1) –≤–º–µ—Å—Ç–æ O(n) –¥–ª—è –±–æ–ª—å—à–∏—Ö –∏—Å—Ç–æ—Ä–∏–π
- **–ê–Ω–∞–ª–∏—Ç–∏–∫–∞**: –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î –≤–º–µ—Å—Ç–æ Python
- **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å**: –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –º–∏–ª–ª–∏–æ–Ω–∞–º —Å–æ–æ–±—â–µ–Ω–∏–π

### üîß Migration

#### –î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
```bash
# –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—É—é –ë–î (–¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –ø–æ—Ç–µ—Ä—è–Ω—ã)
rm data/agent_runtime.db
# –ù–æ–≤–∞—è –ë–î —Å–æ–∑–¥–∞—Å—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
```

#### –î–ª—è production
–°–º. `DATABASE_IMPROVEMENT_RECOMMENDATIONS.md` –¥–ª—è —Å–∫—Ä–∏–ø—Ç–∞ –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö.

### ‚úÖ Testing

–î–æ–±–∞–≤–ª–µ–Ω –ø–æ–ª–Ω—ã–π –Ω–∞–±–æ—Ä —Ç–µ—Å—Ç–æ–≤:
```bash
uv run python test_database_improvements.py
```

–¢–µ—Å—Ç—ã –ø–æ–∫—Ä—ã–≤–∞—é—Ç:
- ‚úì CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–ª—è —Å–µ—Å—Å–∏–π
- ‚úì –ü–∞–≥–∏–Ω–∞—Ü–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π
- ‚úì –°—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫—É
- ‚úì –ö–æ–Ω—Ç–µ–∫—Å—Ç –∞–≥–µ–Ω—Ç–æ–≤
- ‚úì –ò—Å—Ç–æ—Ä–∏—é –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–π
- ‚úì Soft/hard delete
- ‚úì –û—á–∏—Å—Ç–∫—É —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- ‚úì –û–±—Ä–∞—Ç–Ω—É—é —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

### üìö Documentation

–î–æ–±–∞–≤–ª–µ–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:
- `DATABASE_IMPROVEMENT_RECOMMENDATIONS.md` - –¥–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
- `DATABASE_MIGRATION_GUIDE.md` - —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –º–∏–≥—Ä–∞—Ü–∏–∏ –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é
- `test_database_improvements.py` - –ø—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### üîí Backward Compatibility

**‚úÖ –ü–æ–ª–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å** - –≤—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –º–µ—Ç–æ–¥—ã —Ä–∞–±–æ—Ç–∞—é—Ç –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π:
- `save_session()` - —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ —Ä–∞–Ω—å—à–µ
- `load_session()` - –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ—Ç –∂–µ —Ñ–æ—Ä–º–∞—Ç
- `save_agent_context()` - –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Ç–µ –∂–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
- `load_agent_context()` - –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ—Ç –∂–µ —Ñ–æ—Ä–º–∞—Ç

–°—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ –≤ `session_manager.py` –∏ `agent_context.py` —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π.

### üöÄ Future Enhancements

–í–æ–∑–º–æ–∂–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è –≤ –±—É–¥—É—â–µ–º:
- [ ] Alembic –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏—è–º–∏
- [ ] –ü–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫ –ø–æ —Å–æ–æ–±—â–µ–Ω–∏—è–º
- [ ] –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (audit trail)
- [ ] –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- [ ] –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –ë–î
- [ ] –†–µ–ø–ª–∏–∫–∞—Ü–∏—è –¥–ª—è –≤—ã—Å–æ–∫–æ–π –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏

### üêõ Bug Fixes

- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞ —Å –ø–æ—Ç–µ—Ä–µ–π –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ concurrent updates
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ —É—Ç–µ—á–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
- –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º rollback

### ‚ö†Ô∏è Breaking Changes

**–ù–µ—Ç breaking changes** - API –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–≤–º–µ—Å—Ç–∏–º —Å –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–µ–π.

–ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ: —Å—Ç–∞—Ä–∞—è –ë–î –Ω–µ—Å–æ–≤–º–µ—Å—Ç–∏–º–∞ —Å –Ω–æ–≤–æ–π —Å—Ö–µ–º–æ–π, —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ.

### üìù Notes

- SQLite –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
- PostgreSQL —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è production
- –í—Å–µ timestamps –∏—Å–ø–æ–ª—å–∑—É—é—Ç UTC
- JSON –ø–æ–ª—è –≤–∞–ª–∏–¥–∏—Ä—É—é—Ç—Å—è –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏

---

## –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –Ω–æ–≤—ã—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π

### –ü–∞–≥–∏–Ω–∞—Ü–∏—è
```python
# –ü–æ–ª—É—á–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ 50 —Å–æ–æ–±—â–µ–Ω–∏–π
messages = db.get_messages_paginated(session_id, page=1, page_size=50)
```

### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
```python
# –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Å–µ—Å—Å–∏–∏
stats = db.get_session_stats(session_id)
print(f"–°–æ–æ–±—â–µ–Ω–∏–π: {stats['message_count']}, –¢–æ–∫–µ–Ω–æ–≤: {stats['total_tokens']}")
```

### –ò—Å—Ç–æ—Ä–∏—è –∞–≥–µ–Ω—Ç–æ–≤
```python
# –ü–æ–ª—É—á–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–π
switches = db.get_agent_switch_history(session_id, limit=10)
for switch in switches:
    print(f"{switch['from_agent']} -> {switch['to_agent']}: {switch['reason']}")
```

### Soft Delete
```python
# –ú—è–≥–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ (–º–æ–∂–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å)
db.delete_session(session_id, soft=True)

# –ü–æ–ª—É—á–∏—Ç—å —Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Å—Å–∏–∏
active = db.list_all_sessions(include_deleted=False)
```

### –û—á–∏—Å—Ç–∫–∞
```python
# –£–¥–∞–ª–∏—Ç—å –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Å—Å–∏–∏ —Å—Ç–∞—Ä—à–µ 24 —á–∞—Å–æ–≤
cleaned = db.cleanup_old_sessions(max_age_hours=24)

# –û–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ —É–¥–∞–ª–∏—Ç—å —Å–µ—Å—Å–∏–∏, —É–¥–∞–ª–µ–Ω–Ω—ã–µ –±–æ–ª–µ–µ 30 –¥–Ω–µ–π –Ω–∞–∑–∞–¥
deleted = db.hard_delete_old_sessions(days_old=30)
```
