services:
  gateway:
    build:
      context: ./gateway
      dockerfile: Dockerfile
    ports:
      - "${GATEWAY_PORT}:${GATEWAY_PORT}"
    environment:
      - ENVIRONMENT=${ENVIRONMENT}
      - PORT=${GATEWAY_PORT}
      - AGENT_URL=http://agent-runtime:${AGENT_RUNTIME_PORT}
      - LOG_LEVEL=${LOG_LEVEL}
      - INTERNAL_API_KEY=${INTERNAL_API_KEY}
      - WS_HEARTBEAT_INTERVAL=${WS_HEARTBEAT_INTERVAL}
      - WS_CLOSE_TIMEOUT=${WS_CLOSE_TIMEOUT}
      - MAX_CONCURRENT_REQUESTS=${MAX_CONCURRENT_REQUESTS}
      - REQUEST_TIMEOUT=${REQUEST_TIMEOUT}
    depends_on:
      agent-runtime:
        condition: service_healthy
    networks:
      - codelab-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${GATEWAY_PORT}/health"]
      interval: ${HEALTHCHECK_INTERVAL}
      timeout: ${HEALTHCHECK_TIMEOUT}
      retries: ${HEALTHCHECK_RETRIES}
      start_period: ${HEALTHCHECK_START_PERIOD}

  agent-runtime:
    build:
      context: ./agent-runtime
      dockerfile: Dockerfile
    ports:
      - "${AGENT_RUNTIME_PORT}:${AGENT_RUNTIME_PORT}"
    environment:
      - ENVIRONMENT=${ENVIRONMENT}
      - PORT=${AGENT_RUNTIME_PORT}
      - LLM_PROXY_URL=http://llm-proxy:${LLM_PROXY_PORT}
      - LOG_LEVEL=${LOG_LEVEL}
      - INTERNAL_API_KEY=${INTERNAL_API_KEY}
      - MAX_CONCURRENT_REQUESTS=${MAX_CONCURRENT_REQUESTS}
      - REQUEST_TIMEOUT=${REQUEST_TIMEOUT}
    depends_on:
      llm-proxy:
        condition: service_healthy
    networks:
      - codelab-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${AGENT_RUNTIME_PORT}/health"]
      interval: ${HEALTHCHECK_INTERVAL}
      timeout: ${HEALTHCHECK_TIMEOUT}
      retries: ${HEALTHCHECK_RETRIES}
      start_period: ${HEALTHCHECK_START_PERIOD}

  llm-proxy:
    build:
      context: ./llm-proxy
      dockerfile: Dockerfile
    ports:
      - "${LLM_PROXY_PORT}:${LLM_PROXY_PORT}"
    environment:
      - ENVIRONMENT=${ENVIRONMENT}
      - PORT=${LLM_PROXY_PORT}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - LOG_LEVEL=${LOG_LEVEL}
      - INTERNAL_API_KEY=${INTERNAL_API_KEY}
      - MAX_CONCURRENT_REQUESTS=${MAX_CONCURRENT_REQUESTS}
      - REQUEST_TIMEOUT=${REQUEST_TIMEOUT}
    networks:
      - codelab-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${LLM_PROXY_PORT}/health"]
      interval: ${HEALTHCHECK_INTERVAL}
      timeout: ${HEALTHCHECK_TIMEOUT}
      retries: ${HEALTHCHECK_RETRIES}
      start_period: ${HEALTHCHECK_START_PERIOD}

networks:
  codelab-network:
    driver: bridge
