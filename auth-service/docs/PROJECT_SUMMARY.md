# –†–µ–∑—é–º–µ –ø—Ä–æ–µ–∫—Ç–∞ Auth Service

**–í–µ—Ä—Å–∏—è:** 1.0.0
**–î–∞—Ç–∞:** 20 —è–Ω–≤–∞—Ä—è 2026
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

---

## –û–±–∑–æ—Ä

Auth Service ‚Äî –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –¥–ª—è –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã CodeLab, —Ä–µ–∞–ª–∏–∑—É—é—â–∏–π OAuth2 Authorization Server —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π Password Grant –∏ Refresh Token Grant.

---

## –°–æ–∑–¥–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

### 1. [–¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ](TECHNICAL_SPECIFICATION.md)
**–û–±—ä–µ–º:** ~1500 —Å—Ç—Ä–æ–∫  
**–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ:**
- –ü–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –∫ Auth Service
- OAuth2 —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è (Password Grant, Refresh Token Grant)
- JWT —Ç–æ–∫–µ–Ω—ã (Access –∏ Refresh)
- –ú–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö (Users, OAuth Clients, Refresh Tokens, Audit Logs)
- API –∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏
- –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏ (Gateway, Agent Runtime, LLM Proxy)
- –ù–µ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è (–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ)

**–ö–ª—é—á–µ–≤—ã–µ —Ä–µ—à–µ–Ω–∏—è:**
- ‚úÖ SQLite –≤–º–µ—Å—Ç–æ PostgreSQL (–¥–ª—è —É–ø—Ä–æ—â–µ–Ω–∏—è —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è)
- ‚úÖ RS256 –¥–ª—è JWT (–∞—Å–∏–º–º–µ—Ç—Ä–∏—á–Ω–∞—è –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—è)
- ‚úÖ Refresh token rotation (–æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–µ —Ç–æ–∫–µ–Ω—ã)
- ‚úÖ Stateless access tokens (–Ω–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –ë–î)
- ‚úÖ Redis –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –∏ rate limiting

### 2. [–ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏](IMPLEMENTATION_PLAN.md)
**–û–±—ä–µ–º:** ~800 —Å—Ç—Ä–æ–∫  
**–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ:**
- 12 –∏—Ç–µ—Ä–∞—Ü–∏–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
- –î–µ—Ç–∞–ª—å–Ω—ã–µ –∑–∞–¥–∞—á–∏ –¥–ª—è –∫–∞–∂–¥–æ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏
- –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏–µ–º–∫–∏
- –û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏
- –†–∏—Å–∫–∏ –∏ –º–∏—Ç–∏–≥–∞—Ü–∏—è
- –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –º–µ–∂–¥—É –∏—Ç–µ—Ä–∞—Ü–∏—è–º–∏

**–ò—Ç–µ—Ä–∞—Ü–∏–∏:**
1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã (1-2 –¥–Ω—è)
2. –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö –∏ –º–∏–≥—Ä–∞—Ü–∏–∏ (2-3 –¥–Ω—è)
3. –ö—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—è –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (2-3 –¥–Ω—è)
4. User Service –∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è (2-3 –¥–Ω—è)
5. OAuth2 Password Grant (3-4 –¥–Ω—è)
6. Rate Limiting –∏ –∑–∞—â–∏—Ç–∞ (2-3 –¥–Ω—è)
7. –ê—É–¥–∏—Ç –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (1-2 –¥–Ω—è)
8. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Gateway (2-3 –¥–Ω—è)
9. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Agent Runtime (1-2 –¥–Ω—è)
10. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∏ –ø—Ä–∏–º–µ—Ä—ã (2-3 –¥–Ω—è)
11. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è (3-4 –¥–Ω—è)
12. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ observability (2-3 –¥–Ω—è)
13. –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è –∏ –¥–µ–ø–ª–æ–π (2-3 –¥–Ω—è)

### 3. [–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–æ—á–∫–∏](INTEGRATION_POINTS.md)
**–û–±—ä–µ–º:** ~600 —Å—Ç—Ä–æ–∫  
**–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ:**
- –î–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å Gateway
- –î–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å Agent Runtime
- –î–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å LLM Proxy
- Docker Compose –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
- –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ (6 —ç—Ç–∞–ø–æ–≤)
- –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å (–≥–∏–±—Ä–∏–¥–Ω—ã–π middleware)
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
- Rollback –ø–ª–∞–Ω

**–ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã:**
- –ü–µ—Ä–µ—Ö–æ–¥–Ω—ã–π –ø–µ—Ä–∏–æ–¥ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —Å—Ç–∞—Ä–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
- JWT Auth Middleware –¥–ª—è –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ JWKS
- –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ user_id –∏–∑ —Ç–æ–∫–µ–Ω–æ–≤

### 4. [README](../README.md)
**–û–±—ä–µ–º:** ~400 —Å—Ç—Ä–æ–∫  
**–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ:**
- –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç
- API endpoints —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏
- –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞
- –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ
- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
- –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- Troubleshooting
- Roadmap

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è

### –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –†–µ—à–µ–Ω–∏–µ | –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ |
|-----------|---------|-------------|
| –Ø–∑—ã–∫ | Python 3.12 | –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º —Å–µ—Ä–≤–∏—Å–∞–º |
| Framework | FastAPI | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–æ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–∞—Ö CodeLab |
| –ë–î | SQLite ‚Üí PostgreSQL | –ü—Ä–æ—Å—Ç–æ—Ç–∞ –¥–ª—è MVP, –º–∏–≥—Ä–∞—Ü–∏—è –¥–ª—è production |
| Cache | Redis | Rate limiting, –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ JWKS |
| JWT | RS256 (RSA 2048) | –ê—Å–∏–º–º–µ—Ç—Ä–∏—á–Ω–∞—è –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—è –¥–ª—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–∏ |
| Password | bcrypt (cost 12) | –°—Ç–∞–Ω–¥–∞—Ä—Ç –∏–Ω–¥—É—Å—Ç—Ä–∏–∏ |
| ORM | SQLAlchemy | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–π, –∞–±—Å—Ç—Ä–∞–∫—Ü–∏—è –ë–î |
| –ú–∏–≥—Ä–∞—Ü–∏–∏ | Alembic | –°—Ç–∞–Ω–¥–∞—Ä—Ç –¥–ª—è SQLAlchemy |

### OAuth2 Grant Types

**MVP:**
- ‚úÖ Password Grant ‚Äî –¥–ª—è Flutter –∫–ª–∏–µ–Ω—Ç–∞
- ‚úÖ Refresh Token Grant ‚Äî –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤

**Post-MVP:**
- ‚è≥ Authorization Code Flow + PKCE ‚Äî –¥–ª—è –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π
- ‚è≥ Client Credentials ‚Äî –¥–ª—è –º–µ–∂—Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è

### JWT –¢–æ–∫–µ–Ω—ã

**Access Token:**
- –í—Ä–µ–º—è –∂–∏–∑–Ω–∏: 15 –º–∏–Ω—É—Ç
- –ê–ª–≥–æ—Ä–∏—Ç–º: RS256
- –•—Ä–∞–Ω–µ–Ω–∏–µ: –ù–ï —Ö—Ä–∞–Ω–∏—Ç—Å—è (stateless)
- –†–∞–∑–º–µ—Ä: ~500-800 –±–∞–π—Ç

**Refresh Token:**
- –í—Ä–µ–º—è –∂–∏–∑–Ω–∏: 30 –¥–Ω–µ–π
- –ê–ª–≥–æ—Ä–∏—Ç–º: RS256
- –•—Ä–∞–Ω–µ–Ω–∏–µ: –≤ –ë–î (—Ö—ç—à jti)
- –û–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π: rotation –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

**–ó–∞—â–∏—Ç–∞:**
- ‚úÖ Rate limiting (5/min –Ω–∞ IP, 10/hour –Ω–∞ username)
- ‚úÖ Brute-force –∑–∞—â–∏—Ç–∞ (–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ—Å–ª–µ 5 –ø–æ–ø—ã—Ç–æ–∫)
- ‚úÖ Refresh token reuse detection
- ‚úÖ HTTPS only
- ‚úÖ Constant-time password comparison

**–í–∞–ª–∏–¥–∞—Ü–∏—è:**
- ‚úÖ Email —Ñ–æ—Ä–º–∞—Ç
- ‚úÖ –ü–∞—Ä–æ–ª—å —Å–ª–æ–∂–Ω–æ—Å—Ç—å (8+ —Å–∏–º–≤–æ–ª–æ–≤, –∑–∞–≥–ª–∞–≤–Ω—ã–µ, —Ü–∏—Ñ—Ä—ã, —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª—ã)
- ‚úÖ Scope –≤–∞–ª–∏–¥–∞—Ü–∏—è
- ‚úÖ Grant type –≤–∞–ª–∏–¥–∞—Ü–∏—è

---

## –ú–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö

### –¢–∞–±–ª–∏—Ü—ã

1. **users** ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å–∏—Å—Ç–µ–º—ã
   - id (UUID), username, email, password_hash
   - is_active, is_verified
   - created_at, updated_at, last_login_at

2. **oauth_clients** ‚Äî OAuth –∫–ª–∏–µ–Ω—Ç—ã
   - id (UUID), client_id, client_secret_hash
   - allowed_scopes, allowed_grant_types
   - access_token_lifetime, refresh_token_lifetime

3. **refresh_tokens** ‚Äî refresh —Ç–æ–∫–µ–Ω—ã
   - id (UUID), jti_hash, user_id, client_id
   - scope, expires_at, revoked
   - parent_jti_hash (–¥–ª—è rotation chain)

4. **audit_logs** ‚Äî –∞—É–¥–∏—Ç –ª–æ–≥–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
   - id (UUID), user_id, client_id, event_type
   - event_data (JSONB), ip_address, user_agent
   - success, error_message

### –ò–Ω–¥–µ–∫—Å—ã

- users: email, username, is_active
- oauth_clients: client_id, is_active
- refresh_tokens: jti_hash, user_id, expires_at, revoked
- audit_logs: user_id, event_type, created_at, success

---

## API Endpoints

### POST /oauth/token
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –í—ã–¥–∞—á–∞ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤

**Grant Types:**
- `password` ‚Äî –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ login/password
- `refresh_token` ‚Äî –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ access token

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- grant_type (required)
- username, password (–¥–ª—è password grant)
- refresh_token (–¥–ª—è refresh_token grant)
- client_id (required)
- scope (optional)

**–û—Ç–≤–µ—Ç:**
```json
{
  "access_token": "...",
  "refresh_token": "...",
  "token_type": "bearer",
  "expires_in": 900,
  "scope": "api:read api:write"
}
```

### GET /.well-known/jwks.json
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ü—É–±–ª–∏—á–Ω—ã–µ –∫–ª—é—á–∏ –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ JWT

**–û—Ç–≤–µ—Ç:**
```json
{
  "keys": [
    {
      "kty": "RSA",
      "use": "sig",
      "kid": "2024-01-key-1",
      "alg": "RS256",
      "n": "...",
      "e": "AQAB"
    }
  ]
}
```

### GET /health
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** Health check

**–û—Ç–≤–µ—Ç:**
```json
{
  "status": "healthy",
  "version": "0.1.0",
  "database": "connected",
  "redis": "connected"
}
```

---

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏

### Gateway

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
1. –î–æ–±–∞–≤–∏—Ç—å `python-jose[cryptography]`
2. –°–æ–∑–¥–∞—Ç—å `JWTAuthMiddleware`
3. –ü–æ–ª—É—á–∞—Ç—å JWKS –æ—Ç Auth Service
4. –í–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å JWT —Ç–æ–∫–µ–Ω—ã
5. –ò–∑–≤–ª–µ–∫–∞—Ç—å user_id –∏ scope

**–ü–µ—Ä–µ—Ö–æ–¥–Ω—ã–π –ø–µ—Ä–∏–æ–¥:**
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ JWT –∏ X-Internal-Auth –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
- –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ–±–æ–∏—Ö –º–µ—Ç–æ–¥–æ–≤

### Agent Runtime

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
1. –î–æ–±–∞–≤–∏—Ç—å `JWTAuthMiddleware`
2. –î–æ–±–∞–≤–∏—Ç—å `user_id` –≤ –º–æ–¥–µ–ª–∏ —Å–µ—Å—Å–∏–π
3. –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –ë–î
4. –ü—Ä–∏–≤—è–∑–∞—Ç—å —Å–µ—Å—Å–∏–∏ –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º

### LLM Proxy

**–†–µ—à–µ–Ω–∏–µ:**
- –û—Å—Ç–∞–≤–∏—Ç—å –≤–Ω—É—Ç—Ä–µ–Ω–Ω—é—é –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é (X-Internal-Auth)
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏
- –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –¥–æ–±–∞–≤–∏—Ç—å JWT –¥–ª—è –ø—Ä—è–º–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞

---

## –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏

### –≠—Ç–∞–ø 1: –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ Auth Service (–Ω–µ–¥–µ–ª—è 1-2)
- –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å Auth Service
- –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å OAuth2 flow

### –≠—Ç–∞–ø 2: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Gateway (–Ω–µ–¥–µ–ª—è 3)
- –î–æ–±–∞–≤–∏—Ç—å JWTAuthMiddleware
- –ü–µ—Ä–µ—Ö–æ–¥–Ω—ã–π –ø–µ—Ä–∏–æ–¥ (–æ–±–∞ –º–µ—Ç–æ–¥–∞)
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –≠—Ç–∞–ø 3: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Flutter –∫–ª–∏–µ–Ω—Ç–∞ (–Ω–µ–¥–µ–ª—è 4)
- –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å OAuth2 flow
- –•—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤
- –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ

### –≠—Ç–∞–ø 4: –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ Gateway –Ω–∞ JWT (–Ω–µ–¥–µ–ª—è 5)
- –í–∫–ª—é—á–∏—Ç—å JWT –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- –û—Ç–∫–∞—Ç –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö

### –≠—Ç–∞–ø 5: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Agent Runtime (–Ω–µ–¥–µ–ª—è 6)
- –î–æ–±–∞–≤–∏—Ç—å JWTAuthMiddleware
- –û–±–Ω–æ–≤–∏—Ç—å –º–æ–¥–µ–ª–∏
- –ú–∏–≥—Ä–∞—Ü–∏—è –ë–î

### –≠—Ç–∞–ø 6: –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (–Ω–µ–¥–µ–ª—è 7-8)
- –£–±–µ–¥–∏—Ç—å—Å—è –≤ –º–∏–≥—Ä–∞—Ü–∏–∏ –≤—Å–µ—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤
- –£–¥–∞–ª–∏—Ç—å InternalAuthMiddleware
- –§–∏–Ω–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

---

## –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è
- ‚ö° –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ `/oauth/token` < 200ms (p95)
- ‚ö° Throughput: 100 RPS –Ω–∞ –∏–Ω—Å—Ç–∞–Ω—Å
- ‚ö° Latency JWKS endpoint < 50ms
- üõ°Ô∏è –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å: 99.9%

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è
- JWKS –∫—ç—à–∏—Ä—É–µ—Ç—Å—è –≤ Redis (TTL 1 —á–∞—Å)
- OAuth clients –∫—ç—à–∏—Ä—É—é—Ç—Å—è (TTL 5 –º–∏–Ω—É—Ç)
- SQLite –≤ WAL —Ä–µ–∂–∏–º–µ
- Connection pooling
- –ò–Ω–¥–µ–∫—Å—ã –Ω–∞ —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –ø–æ–ª—è

### –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ
- Stateless access tokens
- –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ
- –û–±—â–∞—è –ë–î –¥–ª—è refresh tokens
- Redis –¥–ª—è rate limiting

---

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### Coverage
- –¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ: > 80%
- Unit —Ç–µ—Å—Ç—ã –¥–ª—è –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
- Integration —Ç–µ—Å—Ç—ã –¥–ª—è OAuth2 flow
- Security —Ç–µ—Å—Ç—ã
- Performance —Ç–µ—Å—Ç—ã

### –¢–∏–ø—ã —Ç–µ—Å—Ç–æ–≤
1. **Unit —Ç–µ—Å—Ç—ã** ‚Äî —Å–µ—Ä–≤–∏—Å—ã, —É—Ç–∏–ª–∏—Ç—ã, middleware
2. **Integration —Ç–µ—Å—Ç—ã** ‚Äî –ø–æ–ª–Ω—ã–π OAuth2 flow
3. **Security —Ç–µ—Å—Ç—ã** ‚Äî SQL injection, JWT tampering, brute-force
4. **Performance —Ç–µ—Å—Ç—ã** ‚Äî load testing, latency benchmarks

---

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### Prometheus –º–µ—Ç—Ä–∏–∫–∏
- `auth_token_requests_total` ‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤
- `auth_token_request_duration_seconds` ‚Äî –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
- `auth_failed_login_attempts_total` ‚Äî –Ω–µ—É–¥–∞—á–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏
- `auth_refresh_token_rotations_total` ‚Äî —Ä–æ—Ç–∞—Ü–∏–∏ —Ç–æ–∫–µ–Ω–æ–≤

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- Structured logs (JSON)
- Correlation ID
- –°–æ–±—ã—Ç–∏—è: login, token_refresh, token_revoke
- –ë–µ–∑ –ø–∞—Ä–æ–ª–µ–π –∏ —Ç–æ–∫–µ–Ω–æ–≤ –≤ –ª–æ–≥–∞—Ö

### Alerting
- –í—ã—Å–æ–∫–∏–π –ø—Ä–æ—Ü–µ–Ω—Ç –Ω–µ—É–¥–∞—á–Ω—ã—Ö –≤—Ö–æ–¥–æ–≤
- –ú–µ–¥–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã (> 200ms)
- –ü—Ä–æ–±–ª–µ–º—ã —Å –ë–î –∏–ª–∏ Redis
- –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ refresh token reuse

---

## –†–∏—Å–∫–∏ –∏ –º–∏—Ç–∏–≥–∞—Ü–∏—è

### –†–∏—Å–∫ 1: –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å SQLite
**–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å:** –°—Ä–µ–¥–Ω—è—è  
**–í–ª–∏—è–Ω–∏–µ:** –°—Ä–µ–¥–Ω–µ–µ  
**–ú–∏—Ç–∏–≥–∞—Ü–∏—è:**
- WAL —Ä–µ–∂–∏–º
- –ê–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
- –ü–ª–∞–Ω –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ PostgreSQL

### –†–∏—Å–∫ 2: –ü—Ä–æ–±–ª–µ–º—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
**–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å:** –°—Ä–µ–¥–Ω—è—è  
**–í–ª–∏—è–Ω–∏–µ:** –ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ  
**–ú–∏—Ç–∏–≥–∞—Ü–∏—è:**
- Security —Ç–µ—Å—Ç—ã
- Code review
- –ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏

### –†–∏—Å–∫ 3: –ü—Ä–æ–±–ª–µ–º—ã –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
**–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å:** –°—Ä–µ–¥–Ω—è—è  
**–í–ª–∏—è–Ω–∏–µ:** –í—ã—Å–æ–∫–æ–µ  
**–ú–∏—Ç–∏–≥–∞—Ü–∏—è:**
- –†–∞–Ω–Ω—è—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
- –ü–µ—Ä–µ—Ö–æ–¥–Ω—ã–π –ø–µ—Ä–∏–æ–¥
- Rollback –ø–ª–∞–Ω

---

## Roadmap

### MVP (6-8 –Ω–µ–¥–µ–ª—å)
- ‚úÖ OAuth2 Password Grant
- ‚úÖ Refresh Token Grant
- ‚úÖ JWT —Ç–æ–∫–µ–Ω—ã (RS256)
- ‚úÖ JWKS endpoint
- ‚úÖ Rate limiting
- ‚úÖ –ê—É–¥–∏—Ç –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Gateway –∏ Agent Runtime

### Post-MVP

**–§–∞–∑–∞ 2: Authorization Code Flow (4-6 –Ω–µ–¥–µ–ª—å)**
- Authorization Code Grant + PKCE
- Consent screen UI
- Redirect URI validation

**–§–∞–∑–∞ 3: Client Credentials (2-3 –Ω–µ–¥–µ–ª–∏)**
- –ú–µ–∂—Å–µ—Ä–≤–∏—Å–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
- Service accounts

**–§–∞–∑–∞ 4: RBAC (4-6 –Ω–µ–¥–µ–ª—å)**
- –†–æ–ª–∏ –∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è
- –ò–µ—Ä–∞—Ä—Ö–∏—è —Ä–æ–ª–µ–π
- Admin UI –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è

**–§–∞–∑–∞ 5: SSO (6-8 –Ω–µ–¥–µ–ª—å)**
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Google, GitHub
- SAML 2.0
- OpenID Connect

**–§–∞–∑–∞ 6: Advanced Security (4-6 –Ω–µ–¥–µ–ª—å)**
- Multi-factor authentication (MFA)
- Device fingerprinting
- Anomaly detection

**–§–∞–∑–∞ 7: PostgreSQL Migration (1-2 –Ω–µ–¥–µ–ª–∏)**
- –ú–∏–≥—Ä–∞—Ü–∏—è —Å SQLite –Ω–∞ PostgreSQL
- –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ
- Read replicas

---

## –û—Ü–µ–Ω–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤

### –ö–æ–º–∞–Ω–¥–∞
- **Backend Developer:** 1 FTE
- **DevOps Engineer:** 0.5 FTE
- **QA Engineer:** 0.5 FTE
- **–ò—Ç–æ–≥–æ:** 2 FTE

### –í—Ä–µ–º—è
- **–ú–∏–Ω–∏–º—É–º:** 25 –¥–Ω–µ–π (5 –Ω–µ–¥–µ–ª—å)
- **–ú–∞–∫—Å–∏–º—É–º:** 38 –¥–Ω–µ–π (7.6 –Ω–µ–¥–µ–ª—å)
- **–†–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ:** 30-40 –¥–Ω–µ–π (6-8 –Ω–µ–¥–µ–ª—å)

### –°—Ç–æ–∏–º–æ—Å—Ç—å (–ø—Ä–∏–º–µ—Ä–Ω–∞—è)
- Backend Developer: 40 –¥–Ω–µ–π √ó $500/–¥–µ–Ω—å = $20,000
- DevOps Engineer: 20 –¥–Ω–µ–π √ó $400/–¥–µ–Ω—å = $8,000
- QA Engineer: 20 –¥–Ω–µ–π √ó $350/–¥–µ–Ω—å = $7,000
- **–ò—Ç–æ–≥–æ:** ~$35,000

---

## –ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞

### –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ
- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –≤–æ–π—Ç–∏ –ø–æ login/password
- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –æ–±–Ω–æ–≤–∏—Ç—å access token
- ‚úÖ Gateway –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç JWT —Ç–æ–∫–µ–Ω—ã
- ‚úÖ Refresh token —Ä–æ—Ç–∏—Ä—É–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ Reuse detection —Ä–∞–±–æ—Ç–∞–µ—Ç

### –ù–µ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ
- ‚úÖ –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ < 200ms (p95)
- ‚úÖ Throughput > 100 RPS
- ‚úÖ Coverage > 80%
- ‚úÖ –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å > 99.9%

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- ‚úÖ Rate limiting —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ Brute-force –∑–∞—â–∏—Ç–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ JWT —Ç–æ–∫–µ–Ω—ã –≤–∞–ª–∏–¥–∏—Ä—É—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ Security —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç

---

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### –ù–µ–º–µ–¥–ª–µ–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
1. ‚úÖ –£—Ç–≤–µ—Ä–¥–∏—Ç—å –¢–ó –∏ –ø–ª–∞–Ω
2. ‚è≥ –°–æ–∑–¥–∞—Ç—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π/–≤–µ—Ç–∫—É
3. ‚è≥ –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –æ–∫—Ä—É–∂–µ–Ω–∏–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
4. ‚è≥ –ù–∞—á–∞—Ç—å –∏—Ç–µ—Ä–∞—Ü–∏—é 0 (–∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞)

### –ü–µ—Ä–≤–∞—è –Ω–µ–¥–µ–ª—è
- –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Docker Compose
- –°–æ–∑–¥–∞—Ç—å –±–∞–∑–æ–≤—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø—Ä–æ–µ–∫—Ç–∞
- –ù–∞—Å—Ç—Ä–æ–∏—Ç—å SQLite –∏ Redis
- –°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—ã–µ –º–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö

### –ü–µ—Ä–≤—ã–π –º–µ—Å—è—Ü
- –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å OAuth2 Password Grant
- –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å Refresh Token Grant
- –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Å Gateway
- –ü—Ä–æ–≤–µ—Å—Ç–∏ –ø–µ—Ä–≤—ã–µ —Ç–µ—Å—Ç—ã

---

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–°–æ–∑–¥–∞–Ω–∞ –ø–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ Auth Service:

1. **–¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ** ‚Äî –¥–µ—Ç–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∏ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏
2. **–ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏** ‚Äî –ø–æ—à–∞–≥–æ–≤—ã–π –ø–ª–∞–Ω –Ω–∞ 12 –∏—Ç–µ—Ä–∞—Ü–∏–π
3. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–æ—á–∫–∏** ‚Äî –¥–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏
4. **README** ‚Äî —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞

–ü—Ä–æ–µ–∫—Ç –≥–æ—Ç–æ–≤ –∫ –Ω–∞—á–∞–ª—É —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏. –í—Å–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è –ø—Ä–∏–Ω—è—Ç—ã —Å —É—á–µ—Ç–æ–º:
- –°—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã CodeLab
- –¢—Ä–µ–±–æ–≤–∞–Ω–∏–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç–∏
- –ü—Ä–æ—Å—Ç–æ—Ç—ã —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è (SQLite –¥–ª—è MVP)
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ PostgreSQL

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏  
**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –ù–∞—á–∞—Ç—å –∏—Ç–µ—Ä–∞—Ü–∏—é 0 (–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã)

---

## –ö–æ–Ω—Ç–∞–∫—Ç—ã

**–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫:** Sergey Penkovsky  
**Email:** sergey.penkovsky@gmail.com  
**–ü—Ä–æ–µ–∫—Ç:** CodeLab Auth Service  
**–î–∞—Ç–∞:** 2026-01-05
