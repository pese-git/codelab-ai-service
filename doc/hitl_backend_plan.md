# План работ по внедрению Human-in-the-Loop (HITL) на backend

## 1. Анализ вызова инструментов
- **Добавить механизм инспекции каждого tool call**: В слое orchestration, перед фактическим выполнением инструмента, реализовать перехват вызова.
- **Конфигурируемая "политика вмешательства" (policy)**:
    - Имплементировать политику, определяющую опасные действия (запись, SQL, api-запросы и др.)
    - Возможность настраивать политики для разных пользователей/workspace/агентов.

## 2. Механизм прерывания и сохранения состояния
- **Слой персистентности состояний графа**:
    - Определить, где и как хранится состояние сессии/графа выполнения (БД, Redis, etc).
    - Сохранять: запрос пользователя, предложения агента, контекст, текущий инструмент и его параметры.
- **Возможность паузы выполнения**:
    - В orchestration/logical flow добавить этап “HITL pending”.
    - Сервис должен приостанавливать обработку и уведомлять gateway/UI о необходимости решения пользователя.

## 3. Протокол коммуникации gateway ⇄ UI ⇄ runtime
- **Расширение Websocket-протокола и API**:
    - Новое событие (например, `tool_call_pending_review`) от backend → UI.
    - Возможность отправить от UI решение: approve / edit / reject (c фидбеком).
    - Описать новые message types согласно `agent_extended_protocol.md` и `websocket-protocol.md`.

## 4. Решения пользователя
- **Обработка действий пользователя**:
    - Approve: продолжить выполнение инструмента как есть.
    - Edit: принять изменённые параметры и продолжить с ними (возможна валидация).
    - Reject: передать в LLM/агенту reject-feedback и завершить/откатить ветку выполнения.

## 5. Изменения в сервисах
### a) agent-runtime
- Изменить orchestrator/tool_call_handler:
    - Перехват tool calls → обрабатывать через policy.
    - Добавить состояние HITL-pending и логику сохранения/ожидания запроса.
- Слой хранения состояния: добавить хранилище (файл, БД, Redis).
- REST/Websocket endpoint для обработки действий (approve/edit/reject).
### b) gateway
- Обеспечить транспарентность HITL-состояний до UI.
- Реализовать пересылку событий об ожидании вмешательства.
- Получать решения пользователя и отправлять их обратно в agent-runtime.
- (При необходимости — имлементация своей промежуточной логики для HITL, например, кеширование, кастомные policy на gateway-уровне).

## 6. UI-интеграция
- (Backend-часть): поддержать новые websocket-сообщения, чтобы UI мог отображать состояние ожидания и отправлять решения.

## 7. Логирование и аудит
- Добавить аудит-логи вмешательств: кто, когда, что одобрил/отклонил/отредактировал, и с каким результатом.


## Кратко: основные задачи для backend
1. Реализация policy engine для выбора инструментов, требующих HITL.
2. Добавление pausing/review состояния в сессии tool execution с сохранением состояния.
3. Расширение websocket протоколов и API для интерактива с UI.
4. Новые обработчики для approve/edit/reject tool call.
5. Миграция состояния execution после решения пользователя (resume/cancel/modify).
6. Логирование и трассировка действий пользователя.
