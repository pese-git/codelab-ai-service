# Тестовый план для микросервисного сервиса CodeLab AI

## 1. Общие цели тестирования

- Обеспечить устойчивую и предсказуемую работу каждого сервиса (gateway, agent-runtime, llm-proxy) по отдельности и в связке.
- Раннее выявление багов, ограничение регрессий.
- Поддержка требований к безопасности и производительности.
- Гарантии соответствия API спецификации (OpenAPI).
- Автоматизация тестирования для CI/CD.

---

## 2. Виды тестов и области покрытия

### 2.1 Unit-тесты

**Цели:**  
Покрытие изолированной логики функций, методов, моделей.

**Примеры покрываемых областей:**
- Pydantic-схемы и их валидация (валидные/невалидные payload).
- Функции буферизации токенов, манипуляции сессиями.
- Внутренняя обработка SSE- и WebSocket-сообщений.
- Модули утилит (разбиение текста, агрегация токенов).

### 2.2 Интеграционные тесты

**Цели:**  
Проверка работы микросервисной цепочки как единого решения.

**Примеры:**
- Сквозной поток user_message —> gateway —> agent-runtime —> llm-proxy —> SSE —> WebSocket.
- Успешный и ошибочный обмен данными между сервисами.
- Подключение/перезапуск сервисов, повторяемость сценариев.

### 2.3 Error-тесты

**Цели:**  
Проверка обработки нестандартных и ошибочных случаев.

**Примеры:**
- Неожиданные разрывы соединения (WebSocket, SSE).
- Неожиданные/некорректные данные в запросе.
- Превышение лимитов (по размеру, частоте).
- Нет доступности LLM-backend, внутренние ошибки.

### 2.4 Security-тесты

**Цели:**  
Гарантия, что сервисы защищены от неавторизованных запросов и нарушений контрактов.

**Примеры:**
- Проверка внутренних ключей доступа (X-Internal-Auth).
- Попытка обхода API без авторизации.
- Лимиты на соединения, попытка DoS.

### 2.5 Performance и нагрузочные тесты

**Цели:**  
Удостовериться, что сервисы выдерживают штатную и пиковую нагрузку.

**Примеры:**
- 100+ одновременных WebSocket-сессий.
- Потоковое получение токенов с высокой частотой.
- Сценарии “burst”-нагрузки (много запросов за короткое время).

### 2.6 Recovery и resilience

**Цели:**  
Проверить устойчивость к сбоям и корректное восстановление.

**Примеры:**
- Перезапуск одного или нескольких сервисов на горячую.
- Проверка восстановления сессий (если поддерживается).
- Непрерывность потока данных (или корректная ошибка для клиента).

### 2.7 API/Contract тесты

**Цели:**  
Убедиться в соответствии фактических ответов спецификациям OpenAPI.

**Примеры:**
- Проверка формата, типов полей, вариативности ответов.
- Проверка опциональных и обязательных полей.
- Проверка backwards compatible изменений.

### 2.8 End-to-End (e2e) тесты

**Цели:**  
Проверить сценарий пользователя в boт- и cli-интерфейсе до конца цепочки.

**Примеры:**
- Автоматическая работа через cli_chat.py с разными сценариями.
- Множественные exchange-сессии и проверка history чата.

---

## 3. Стандарты качества/покрытия

- Не менее 80% покрытия unit-тестами для внутренних функций и моделей.
- Интеграционные тесты для основных пользовательских сценариев (happy path и error).
- Перечень ключевых негативных сценариев для error/security тестов.
- Перфоманс: выдержка базовой целевой нагрузки (указывается для команды).
- Единообразные проверки contract API при каждом CI/CD прогонах.
- Тесты должны быть repeatable и независимы друг от друга.

---

## 4. Организация тестовой инфраструктуры

- **Запуск unit/integration**: pytest, pytest-asyncio, httpx, websockets.
- **Mock/integration**: при необходимости — monkeypatch/mocker для имитации сервисов/зависимостей.
- **Нагрузочные**: artillery, locust, custom runner на Python.
- **OpenAPI contract**: schemathesis, openapi-tester.
- Поддержка многосервисного запуска через docker-compose для интеграционного сценария.
- CI: автоматический прогон всех видов тестов при каждом Pull Request и на nightly build.

---

## 5. Процесс согласования и обновления тестов

- Любое значимое изменение бизнес-логики — обязательно с актуализацией/расширением тестов.
- На каждый новый endpoint и внутреннюю функцию — хотя бы базовый unit-тест.
- Плановые ревью покрытий и уязвимых мест раз в спринт.
- Интеграция в CI/CD — блокирующий фактор для слияния Pull Request без успешного тестового прогона.

---

## 6. Ответственные и коммуникация

- За тесты по каждому сервису отвечает ведущий разработчик соответствующего компонента.
- Интеграционные/нагрузочные/сквозные тесты координируются лидом (или QA-инженером).
- Все тест-кейсы и тестовые сценарии ведутся в issue tracker или в документации проекта.

---

## 7. Итоговые критерии:

- Все ключевые сценарии покрыты автотестами (unit + integration + e2e).
- Нет «пробелов» в error/security flow.
- Любой баг корректируется новым тестом, предотвращающим регрессию.
- Отклонение от спецификации/контрактов не попадает в мастер-ветку.

---

**Пример структуры тестового каталога:**
```
project-root/
├── gateway/
│   └── tests/
├── agent-runtime/
│   └── tests/
├── llm-proxy/
│   └── tests/
├── tests/                # Общие интеграционные и e2e-тесты
```
