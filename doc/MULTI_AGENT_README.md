# Мультиагентная система для Agent Runtime

## 📋 Обзор

Полная архитектура и план реализации мультиагентной системы для Agent Runtime сервиса.

## 🎯 Цель

Создать специализированную мультиагентную систему с 5 агентами, каждый из которых является экспертом в своей области:

- **Orchestrator** 🎭 - главный координатор
- **Coder** 💻 - разработчик кода
- **Architect** 🏗️ - проектировщик архитектуры
- **Debug** 🐛 - отладчик и диагност
- **Ask** 💬 - консультант и учитель

## 📚 Документация

### 1. [Быстрый старт](./multi-agent-quick-start.md)
Краткое введение с примерами использования и основными концепциями.

**Содержит:**
- Обзор агентов
- Примеры API запросов
- Типичные сценарии использования
- Ограничения агентов

### 2. [Архитектура и план реализации](./multi-agent-architecture-plan.md)
Детальный план архитектуры с примерами кода и этапами реализации.

**Содержит:**
- Анализ текущей архитектуры
- Целевая архитектура
- Структура классов и модулей
- Примеры реализации
- План поэтапной реализации
- Интеграция с Gateway и IDE

### 3. [Диаграммы архитектуры](./multi-agent-architecture-diagram.md)
Визуализация архитектуры через Mermaid диаграммы.

**Содержит:**
- Общая архитектура системы
- Поток обработки сообщений
- Переключение между агентами
- Структура классов
- Поток данных в сессии
- Жизненный цикл сессии

## 🚀 Быстрый старт

### Основная идея

```
User Message → Orchestrator → Специализированный Агент → LLM → Tools → Result
```

### Пример использования

```bash
# Автоматическое определение агента
curl -X POST http://localhost:8001/agent/message/stream \
  -H "Content-Type: application/json" \
  -d '{
    "session_id": "session_123",
    "message": {
      "type": "user_message",
      "content": "Create a new widget"
    }
  }'

# Результат: Orchestrator → Coder (автоматически)
```

## 🏗️ Архитектура

### Компоненты системы

```
┌─────────────────────────────────────────────────┐
│           Multi-Agent Orchestrator              │
│  ┌───────────────────────────────────────────┐  │
│  │         Agent Router & Context            │  │
│  └───────────────────────────────────────────┘  │
│                                                  │
│  ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐ │
│  │ Orch │ │Coder │ │Arch  │ │Debug │ │ Ask  │ │
│  └──────┘ └──────┘ └──────┘ └──────┘ └──────┘ │
│                                                  │
│  ┌───────────────────────────────────────────┐  │
│  │         LLM Stream Service                │  │
│  └───────────────────────────────────────────┘  │
└─────────────────────────────────────────────────┘
```

### Специализация агентов

| Агент | Инструменты | Ограничения |
|-------|-------------|-------------|
| **Orchestrator** | read_file, list_files, search_in_code | Только анализ |
| **Coder** | Все инструменты | Нет ограничений |
| **Architect** | read_file, write_file, list_files, search_in_code | Только .md файлы |
| **Debug** | read_file, list_files, search_in_code, execute_command | Без write_file |
| **Ask** | read_file, search_in_code, list_files | Только чтение |

## 📝 План реализации

### Этап 1: Базовая инфраструктура (1-2 дня)
- [x] Создать `BaseAgent` класс
- [x] Создать `AgentRouter`
- [x] Создать `AgentContext` и `AgentContextManager`
- [x] Обновить схемы данных

### Этап 2: Реализация агентов (2-3 дня)
- [x] Реализовать `OrchestratorAgent`
- [x] Реализовать `CoderAgent`
- [x] Реализовать `ArchitectAgent`
- [x] Реализовать `DebugAgent`
- [x] Реализовать `AskAgent`
- [x] Создать промпты для каждого агента

### Этап 3: Оркестрация (2-3 дня)
- [x] Реализовать `MultiAgentOrchestrator`
- [x] Интегрировать с `llm_stream_service`
- [x] Обновить API endpoints
- [x] Добавить логирование

### Этап 4: Тестирование (2-3 дня)
- [ ] Unit-тесты для каждого агента
- [ ] Integration-тесты
- [ ] E2E тесты через API
- [ ] Тестирование переключений

### Этап 5: Документация (1-2 дня)
- [x] Документация API
- [x] Примеры использования
- [ ] Оптимизация
- [ ] Настройка конфигурации

## 🔧 Конфигурация

```bash
# .env
AGENT_RUNTIME__MULTI_AGENT_ENABLED=true
AGENT_RUNTIME__DEFAULT_AGENT=orchestrator
AGENT_RUNTIME__AUTO_AGENT_SWITCHING=true
AGENT_RUNTIME__MAX_AGENT_SWITCHES=10
```

## 📊 Метрики и мониторинг

Система предоставляет метрики для:
- Количество запросов к каждому агенту
- Время обработки по агентам
- Количество переключений агентов
- Успешность выполнения задач
- Использование инструментов

## 🔐 Безопасность

- ✅ Ограничения на инструменты для каждого агента
- ✅ Валидация редактирования файлов
- ✅ Контроль опасных команд
- ✅ Логирование всех действий
- ✅ Ограничение количества переключений

## 🎨 Интеграция с IDE

### Gateway изменения
1. Поддержка `agent_switched` событий
2. Отображение текущего агента в UI
3. Кнопки переключения агентов
4. История переключений

### IDE изменения
1. Индикатор текущего агента
2. Цветовая кодировка по агентам
3. История действий агентов
4. Статистика использования

## 📖 Примеры сценариев

### Создание компонента
```
User: "Create a user profile widget"
→ Orchestrator анализирует
→ Переключается на Coder
→ Coder создает файл
→ Возвращает результат
```

### Отладка ошибки
```
User: "Why null pointer exception?"
→ Orchestrator анализирует
→ Переключается на Debug
→ Debug находит причину
→ User: "Fix it"
→ Debug переключается на Coder
→ Coder исправляет
```

### Проектирование
```
User: "Design auth system"
→ Orchestrator анализирует
→ Переключается на Architect
→ Architect создает спецификацию
→ User: "Implement login"
→ Architect переключается на Coder
→ Coder реализует
```

## 🚦 Статус реализации

- ✅ Архитектура спроектирована
- ✅ Документация создана
- ✅ Диаграммы подготовлены
- ⏳ Реализация кода (следующий этап)
- ⏳ Тестирование
- ⏳ Интеграция с Gateway

## 🤝 Вклад в проект

Для реализации системы:

1. Изучите документацию в порядке:
   - [Быстрый старт](./multi-agent-quick-start.md)
   - [Архитектура](./multi-agent-architecture-plan.md)
   - [Диаграммы](./multi-agent-architecture-diagram.md)

2. Начните с базовых компонентов:
   - `BaseAgent`
   - `AgentRouter`
   - `AgentContext`

3. Реализуйте агентов по очереди:
   - Orchestrator (самый важный)
   - Coder (самый используемый)
   - Остальные агенты

4. Интегрируйте с существующей системой

5. Добавьте тесты

## 📞 Контакты и поддержка

Для вопросов по реализации обращайтесь к:
- Архитектурному плану для деталей реализации
- Диаграммам для понимания потоков данных
- Быстрому старту для примеров использования

## 🎯 Ключевые преимущества

1. **Специализация** - каждый агент эксперт в своей области
2. **Безопасность** - строгие ограничения на действия
3. **Гибкость** - автоматическое и ручное управление
4. **Наблюдаемость** - полное логирование и метрики
5. **Расширяемость** - легко добавлять новых агентов
6. **Совместимость** - работает с существующей архитектурой

---

**Версия:** 1.0  
**Дата:** 2025-12-30  
**Статус:** Готово к реализации
