events {
    worker_connections 1024;
}

http {
    # Логирование
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

    # Базовые настройки
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;

    # Настройки для WebSocket
    map $http_upgrade $connection_upgrade {
        default upgrade;
        '' close;
    }

    # Upstream для auth-service
    upstream auth_backend {
        server auth-service:8003;
    }

    # Upstream для gateway-service
    upstream gateway_backend {
        server gateway:8000;
    }

    server {
        listen 80;
        server_name localhost;

        # Увеличиваем размер буфера для больших запросов
        client_max_body_size 10M;
        client_body_buffer_size 128k;

        # Настройки для проксирования
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Таймауты
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;

        # Проксирование auth-service OAuth endpoints (без префикса /auth)
        location /oauth/ {
            proxy_pass http://auth_backend/oauth/;
            
            # Дополнительные заголовки для auth
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-Server $host;
        }

        # Проксирование auth-service JWKS endpoints (без префикса /auth)
        location /.well-known/ {
            proxy_pass http://auth_backend/.well-known/;
            
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-Server $host;
        }

        # Health check для auth-service
        location /auth-health {
            proxy_pass http://auth_backend/health;
        }

        # Проксирование gateway-service REST API (v1)
        location /api/v1/ {
            proxy_pass http://gateway_backend/api/v1/;
            
            # Увеличенные таймауты для длительных операций
            proxy_read_timeout 300s;
            proxy_send_timeout 300s;
        }

        # Проксирование WebSocket соединений для gateway
        location ~ ^/api/v1/ws/(.*)$ {
            proxy_pass http://gateway_backend/api/v1/ws/$1;
            
            # WebSocket специфичные заголовки
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            
            # Увеличенные таймауты для WebSocket
            proxy_read_timeout 3600s;
            proxy_send_timeout 3600s;
            
            # Отключаем буферизацию для WebSocket
            proxy_buffering off;
        }

        # Health check для gateway
        location /gateway-health {
            proxy_pass http://gateway_backend/health;
        }

        # Главная страница nginx
        location = / {
            return 200 'Codelab AI Service Proxy\n\nAvailable endpoints:\n- /oauth/* - Authentication OAuth2 endpoints\n- /.well-known/* - JWKS endpoints\n- /auth-health - Auth service health check\n- /api/v1/* - Gateway REST API v1\n- /api/v1/ws/{session_id} - Gateway WebSocket\n- /gateway-health - Gateway health check\n- /nginx-health - Nginx health check\n';
            add_header Content-Type text/plain;
        }

        # Статус nginx
        location /nginx-health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }
    }
}
